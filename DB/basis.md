# データベースの基本

## データベースとは

データベースとは、色々なシステムで使われるデータを1カ所に集めて、活用の利便性を高めたものである。

### データを1カ所で集中管理

データベースでは、データを1カ所に集めることで、情報を集中的に管理でき、そのデータを活用しやすくしている。
統合することで検索しやすくなり、また同じデータがいくつも重複することを避けられるため、業務を効率化できる。

### データ独立

昔のシステム開発では、システムごとにデータを保存してファイルなどに格納していた。
この方法では同じようなデータを重複して持つことになり、データの受け渡しの効率も悪くなる。
そこで、システムからデータを独立させ、そのデータをまとめてデータベースに入れるという方法が考えだされた。
システムからデータを独立させて別に管理することを**データ独立**という。

## データベース基礎理論

### 正規化理論

#### 正規化とは

正規化は一般的に、一定のルールに従って変形を行うことを指す。
関係データベースの正規化では、正規化理論というルールに従って、関係を分解する変形を行う。

#### 関数従属性

関数従属性とは、ある属性Xの値が決まれば、別の属性 Y が一意に決まるという性質である。
これを X→Y と表す。
このとき、Xを決定項、Yを従属項という。
例えば、以下のような顧客表では、顧客番号が定まれば顧客名が一意に決まる。
これが関数従属性であり、「顧客番号→顧客名」と表すことができる。

|<u>顧客番号</u>|顧客名|
|--|--|
|11|ねこ商事|
|13|うさぎ開発|
|29|くま工業|

#### 情報無損失分解

正規かを行うときに、ただ更新時異常を避けるために適当に分解すると、もともと合った情報が失われることがある。
関係を分解する際は、その関係を結合することで元の関係を復元できる必要がある。
分解した関係を自然結合 (後述) したときに元に戻せる分解の仕方を**情報無損失分解**という。
情報無損失分解を行うために正規化の規則があり、第1正規形から順に正規化していくことにより、情報を保持することができる。

#### 第1正規形

第1正規形は、属性 (カラム) が1つのデータ型に基づく単一値をとる関係である。

例えば、次のような関係 "伝票" を考える。

|伝票番号|顧客名(顧客番号)|商品番号|商品名|数量|
|--|--|--|--|--|
|1001|ねこ商事(11)|2001|チョコレート|5|
|    |ねこ商事(11)|2002|キャラメル|5|
|1002|うさぎ開発(13)|2002|キャラメル|3|
|1003|くま工業(29)|2003|ドーナツ|10|
|1004|ねこ商事(11)|2002|キャラメル|5|

この関係は、「顧客名(顧客番号)」の列に複数の値が含まれており、第1正規形の条件を満たしていないため、非正規形となる。

第1正規形にするには、各列が単一の値を持つ必要があるため、複数の値を持つ列を各列に分解すればよい。

|伝票番号|顧客番号|顧客名|商品番号|商品名|数量|
|--|--|--|--|--|--|
|1001|11|ねこ商事|2001|チョコレート|5|
|1001|11|ねこ商事|2002|キャラメル|5|
|1002|13|うさぎ開発|2002|キャラメル|3|
|1003|29|くま工業|2003|ドーナツ|10|
|1004|11|ねこ商事|2002|キャラメル|5|

##### 候補キー

関係のタプル (1行1行のこと) を一意に識別できる属性または属性の組のうち、極小のものを指す。
例えば、以下の関係 "伝票" をもとに、候補キーを考える。

|伝票番号|顧客番号|顧客名|商品番号|商品名|数量|
|--|--|--|--|--|--|
|1001|11|ねこ商事|2001|チョコレート|5|
|1001|11|ねこ商事|2002|キャラメル|5|
|1002|13|うさぎ開発|2002|キャラメル|3|
|1003|29|くま工業|2003|ドーナツ|10|
|1004|11|ねこ商事|2002|キャラメル|5|

上記に次のような条件を加える。

* 顧客は複数回注文するので、伝票は複数ある
* 顧客番号に対応する顧客名の重複はない
* 商品番号に対応する商品名の重複はない

関係 "伝票" では、{伝票番号, 商品番号} の両方が同じ属性の組であるタプルはない。
さらにここから、伝票番号だけ、商品番号だけを取り出すと、両方に同じ値の属性が存在するため、これ以上分割はできない。
このため、{伝票番号, 商品番号} は候補キーとなる。

さらに、**候補キーは一つとは限らない**。
上記の関係の場合、「商品番号に対応する商品名の重複はない」という条件があるため、商品名でも、商品番号の代わりに商品を一意に識別できる。つまり、{伝票番号, 商品名} も候補キーの一つとなる。

##### 主キー

候補キーの中から一つを選んだものであり、NULL ではない必要がある。
候補キーの中から主キーを選ぶ際、通常は番号やコードなどデータのサイズが小さく固定長であるものが採用されることが多い。

この後の第2正規形、第3正規形への正規化では、主キーではなく候補キーを正規化の定義で用いる。
全ての候補キーが対象となるため、全ての候補キーを上げることが重要である。

#### 第2正規形

第2正規形は、テーブルが第1正規形を満たしている上で、全ての非キー属性 (どの候補キーにも当てはまらない属性) が各候補キーに依存している関係である。
第2正規形にするには、各候補キーの一部に従属する部分関数従属性を排除する。

##### 第1正規形の問題点

例として、第1正規形で挙げた関係 "伝票" について考える。
ここで、主キーは {伝票番号, 商品番号} とする。

|<u>伝票番号</u>|顧客番号|顧客名|<u>商品番号</u>|商品名|数量|
|--|--|--|--|--|--|
|1001|11|ねこ商事|2001|チョコレート|5|
|1001|11|ねこ商事|2002|キャラメル|5|
|1002|13|うさぎ開発|2002|キャラメル|3|
|1003|29|くま工業|2003|ドーナツ|10|
|1004|11|ねこ商事|2002|キャラメル|5|

この関係では、次の更新時異状が発生する。

* タプル挿入時異状
  * 伝票番号 1005 の伝票を、購入する商品 (商品番号) が決まる前に (1005, 15, かめ道場, NULL, NULL, NULL) を挿入しようとすると、主キーの商品番号が NULL のため、挿入できない。
* タプル更新時異状
  * 伝票番号 1001 の顧客番号を 15 に、顧客名をかめ道場に変更しようとする場合、伝票番号 1001 の列は 2 行あるため、両方一度に修正する必要がある。1 行だけ修正すると、データに矛盾が生じる。
* タプル削除時異状
  * 伝票番号 1003 の商品番号 2003 のタプルを削除すると、伝票番号 1003 のその他の情報も消失する。これにより、伝票内容に関する情報が保持できなくなる。

これらの問題は、第2正規形に正規化することで解消できる。

##### 部分関数従属性について

関係 "伝票" について、候補キーは以下のとおりである。

* {伝票番号, 商品番号}
* {伝票番号, 商品名}

非キー属性は以下のとおりである。

+ 顧客番号
+ 顧客名
+ 数量

これらの非キー属性について、候補キーに完全に従属しているか (一部のみに従属していないか) を確認する。

+ 顧客番号: {伝票番号} から導出可能
+ 顧客名: {伝票番号} から導出可能
+ 数量: {伝票番号, 商品番号} から導出可能

以上より、候補キー{伝票番号, 商品番号}の一部である{伝票番号}に対して、
{伝票番号} → {顧客番号, 顧客名}
という関数従属性が成り立つ。
このように、候補キーの一部に対して一意に値が定まるような関係を部分関数従属性と呼ぶ。
第2正規形では部分関数従属を排除する。

##### 第2正規形への変換

部分関数従属性を排除するには、部分関数従属{伝票番号}→{顧客番号, 顧客名}を取り出して別のテーブルとして表現する。

伝票 (部分関数従属を別テーブルとして定義した結果)

|<u>伝票番号</u>|顧客番号|顧客名
|--|--|--|
|1001|11|ねこ商事|
|1002|13|うさぎ開発|
|1003|29|くま工業|
|1004|11|ねこ商事|

伝票明細

|<u>伝票番号</u>|<u>商品番号</u>|商品名|数量|
|--|--|--|--|
|1001|2001|チョコレート|5|
|1002|2002|キャラメル|3|
|1003|2003|ドーナツ|10|
|1004|2002|キャラメル|5|

#### 第3正規形

第3正規形は、テーブルが第2正規形を満たしている上で、非キー列間に推移的な依存関係がない関係である。つまり、非キー列同士の依存関係がなく、それぞれの列が直接主キーに依存している状態を指す。

##### 第2正規形の問題点

例として、第2正規形で挙げた関係 "伝票" について考える。

|<u>伝票番号</u>|顧客番号|顧客名
|--|--|--|
|1001|11|ねこ商事|
|1002|13|うさぎ開発|
|1003|29|くま工業|
|1004|11|ねこ商事|

この関係では、次の更新時異状が発生する。

* タプル挿入時異状
  * 顧客番号が15, 顧客名が亀道場のデータを伝票が発生する前に (NULL, 15, かめ道場)のように登録しようとすると、主キーの伝票番号が NULL 不可のため、登録できない。
* タプル更新時異状
  * 顧客番号29のくま工業が社名変更したので、顧客名をくまAKに修正しようとした場合、顧客番号29の列は2行あるため、両方を一度に修正する必要がある。1行だけ更新すると、データに矛盾が生じる。
  * 伝票番号 1001 のタプルを削除すると、顧客番号11のねこ商事の情報が消失する。そのため、顧客に関する情報が保持できなくなる。

これらの問題は、第3正規形に正規化することで解消できる。

##### 推移的関数従属性について

第2正規形で述べた関係 "伝票" について、
伝票番号が決まると顧客番号が決まり、顧客番号が決まると顧客名が決まる。
{伝票番号}→{顧客番号}→{顧客名}
また、顧客番号から伝票番号は一意に定まらない。
このように、
* X→Y が成り立つ
* Y→X が成り立たない
* Y→Z が成り立つ

という関係を推移的関数従属と呼ぶ。
第2正規形を第3正規形にするには、推移的関数従属性を排除する。
具体的には、X→Y→Zという関係において、Y→Zを別のテーブルとする。

顧客

|<u>顧客番号</u>|顧客名|
|--|--|
|11|ねこ商事|
|13|うさぎ開発|
|29|くま工業|

伝票

|<u>伝票番号</u>|<div style="text-decoration: underline dashed">顧客番号</div>|
|--|--|
|1001|11|
|1002|13|
|1003|29|

#### 外部キー

複数の関係を結びつけるためのキーである。
先ほど第3正規形にした次の二つの関係では、関係"伝票"の顧客番号が関係"顧客"の候補キー (主キー) である顧客番号に対する外部キーになる。
外部キーは、両方の関係に共通の値として存在する必要がある。
具体的には、関係"伝票"の顧客番号には、関係"顧客"にある顧客番号を必ず入れなければならない。
ただし、顧客番号が決まってない場合などに NULL を入れるのは許可される。

伝票

|<u>伝票番号</u>|<div style="text-decoration: underline dashed">顧客番号 (外部キー)</div>|
|--|--|
|1001|11|
|1002|13|
|1003|29|

顧客

|<u>顧客番号</u>|顧客名|
|--|--|
|11|ねこ商事|
|13|うさぎ開発|
|29|くま工業|

### 関係演算

#### 和

あまり目にしないので割愛

#### 差

あまり目にしないので割愛

#### 積 (共通)

あまり目にしないので割愛

#### 商

あまり目にしないので割愛

#### 直積

直積とは、二つの関係のそれぞれのタプルをすべて掛け合わせたものである。

関係R

|A|B|
|--|--|
|1|あ|
|2|い|
|3|う|

関係S

|A|C|
|--|--|
|1|か|
|2|き|
|3|く|

直積R×S

|R.A|R.B|S.A|S.C|
|--|--|--|--|
|1|あ|1|か|
|1|あ|2|き|
|1|あ|3|く|
|2|い|1|か|
|2|い|2|き|
|2|い|3|く|
|3|う|1|か|
|3|う|2|き|
|3|う|3|く|

#### 射影

射影とは、関係を縦方向に切り出した関係である。
例えば、関係RからＡのカラムを取り出して、関係R'とすることが射影である。

関係R'

|A|
|--|
|1|
|2|
|3|

#### 選択

選択とは、関係を横方向に切り出した関係である。
例えば、次のような関係RからA<3のタプルを取り出して、関係R'とすることが選択である。

関係R'

|A|B|
|--|--|
|1|あ|
|2|い|

#### 結合

結合とは、二つの関係を共通の属性で結び付けた関係である。

##### 自然結合 INNER JOIN

二つの関係の直積から、共通の属性の値が等しいものを選択し、共通の属性の一つを除いたものの射影を取る。
例えば、直積の例で使用した二つの関係RとSは、直積R×Sから、関係RのA列と、関係SのA列の値が等しい行を選択し、更に関係SのA列を除いた三つの列の射影を取ることで、次のような関係となる。

|R.A|R.B|S.A|S.C|
|--|--|--|--|
|1|あ|1|か|
|1|あ|2|き|
|1|あ|3|く|
|2|い|1|か|
|2|い|2|き|
|2|い|3|く|
|3|う|1|か|
|3|う|2|き|
|3|う|3|く|

↓ (共通の属性 A の値が等しいものを選択)

|R.A|R.B|S.A|S.C|
|--|--|--|--|
|1|あ|1|か|
|2|い|2|き|
|3|う|3|く|

↓ (共通の属性 A を取り除く)

|A|B|C|
|--|--|--|
|1|あ|か|
|2|い|き|
|3|う|く|

##### 左外部結合 LEFT OUTER JOIN
外部結合は、二つの関係のうち片方の関係に一致するものがない場合にも取り出す結合である。

左外部結合は、左側の関係Rの行は全て取り出し、右側の関係Sの行は関係RとA列が一致するもののみを取り出す。

関係R

|A|B|
|--|--|
|1|あ|
|2|い|
|3|う|

関係S

|A|C|
|--|--|
|1|か|
|2|き|
|4|け|

RとSの左外部結合

|A|B|C|
|--|--|--|
|1|あ|か|
|2|い|き|
|3|う|NULL|

##### 右外部結合 RIGHT OUTER JOIN

右外部結合は、右側の関係Sの行は全て取り出し、左側の関係Rの行は関係SとA列が一致するもののみを取り出す。

|A|B|C|
|--|--|--|
|1|あ|か|
|2|い|き|
|4|NULL|け|

##### 完全外部結合 FULL OUTER JOIN

完全外部結合は、共通属性に関し、どちらかの列に存在する行をすべて取り出す。

|A|B|C|
|--|--|--|
|1|あ|か|
|2|い|き|
|3|う|NULL|
|4|NULL|け|

## リレーショナルデータベース


## カバーするトピック

1. **データベースとは何か**
    - データベースの定義
    - データベースの用途

2. **リレーショナルデータベース (RDBMS)**
    - リレーショナルデータベースの概念
    - 主要なRDBMS（MySQL、PostgreSQL、Oracleなど）

3. **データベース設計**
    - エンティティと属性
    - 正規化と非正規化
    - 主キーと外部キー

4. **SQL (Structured Query Language)**
    - SQLの基本クエリ
    - データの検索、挿入、更新、削除

5. **データベース管理システム (DBMS)**
    - DBMSの役割
    - バックアップと復元
    - セキュリティとアクセス制御

6. **NoSQLデータベース**
    - NoSQLデータベースの特徴
    - 主要なNoSQLデータベース（MongoDB、Cassandra、Redisなど）

7. **データベースの選択**
    - 適切なデータベースの選定
    - データベースのパフォーマンスとスケーラビリティ
